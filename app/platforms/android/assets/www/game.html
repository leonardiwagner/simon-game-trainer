<html ng-app="angularApp">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="dist/main.css" />
    <style>
	body{
	  background-image: url('img/backgroun-gym.png');
	  }
	</style>
  </head>
	<body ng-controller="MainController">
    <nav class="navbar navbar-default " style="padding: 5px;">
      <div class="container-fluid">
          <div class="navbar-header">
          <div class="btn btn-primary" onclick="javascript:window.location = 'index.html';">menu</div>
          
          <div class="btn btn-danger" style="float:right;" ng-click="reset()">reset</div>
        </div>
      </div>
    </nav>
    <article>
      <section class="buttons-container">
        <div ng-repeat="button in buttons" on-repeat-render="renderButtons()" class="button button-{{button.name}}" ng-click="clickGenius(button.name)"></div>
        <div id="score">{{breadcrumb.length}}</div>
      </section>

      <section class="repeat-buttons">
        <div class="btn btn-primary btn-repeat btn-block" ng-click="runGenius(0)">repeat</div>
        <!--<div class="btn btn-default btn-repeat-missing" ng-click="runGenius(-1)">repeat missing</div>-->
      </section>

      <section class="breadcrumb">
        <!--<div ng-repeat="item in breadcrumb track by $index" class="btn btn-default button-{{item.name}}"></div>-->
      </section>
    </article>
   
   <script type="text/javascript" src="cordova.js"></script>
   
   <script src="bower_components/angular/angular.min.js"></script>
   <script src="bower_components/jquery/dist/jquery.min.js"></script>
   <script src="bower_components/underscore/underscore-min.js"></script>

   <script>
   //document.addEventListener("deviceready", onDeviceReady, false);
	 
	 //function onDeviceReady() {
		
		window.playSound = function(sound){
			var m = new Media(sound, function(){
				m.release();
			},function(){
				m.release();
			});
			
			m.play();
			
		};
		
		
		
   var ButtonsHandler = function(){
  var SHADOW_SIZE = 9;
  var BUTTON_PRESS_SIZE = 4;
  var BUTTON_PRESS_TIME = 100;
  var BUTTON_LIGHT_TIME = 300;

  var buttons = {
    "green": {
      "name": "green",
      "borderRadiusSelector": "border-top-left-radius",
      "selector":".button.button-green",
      "color": [0,150,0],
      "currentColor": [0,255,0],
      "soundClick":  '/android_asset/www/sound/sound-green.wav'
	 
    },
    "yellow": {
      "name": "yellow",
      "borderRadiusSelector": "border-top-right-radius",
      "selector":".button.button-yellow",
      "color": [200,200,0],
      "currentColor": [0,255,255],
      "soundClick":  '/android_asset/www/sound/sound-yellow.wav'
    },
    "red": {
      "name": "red",
      "borderRadiusSelector": "border-bottom-left-radius",
      "selector":".button.button-red",
      "color": [255,0,0],
      "currentColor": [255,0,0],
      "soundClick":  '/android_asset/www/sound/sound-red.wav'
    },
    "blue": {
      "name": "blue",
      "borderRadiusSelector": "border-bottom-right-radius",
      "selector":".button.button-blue",
      "color": [0,0,180],
      "currentColor": [0,0,255],
      "soundClick": '/android_asset/www/sound/sound-blue.wav'
    }
  };

  var renderButtons = function(){
    var soundClick = '/android_asset/www/sound/sound-click.wav';

    _.each(buttons, function(button){
      setItemColor($(button.selector), button, true);
    });
  };

  var setItemColor = function(element, button, changeBorder){
    //set color and radius
    var buttonOriginalColor = changeColor(button.color,[0,0,0]);
    element.css("background-color", buttonOriginalColor);
    if(changeBorder){
      //set shadow and border
      element.css(button.borderRadiusSelector, "30%");
      var shadowColor = changeColor(button.color, [-100, -100, -100]);
      element.css("box-shadow", "0px " + SHADOW_SIZE + "px 0px " + shadowColor);
      element.css("-moz-box-shadow", "0px " + SHADOW_SIZE + "px 0px " + shadowColor);
      element.css("-webkit-box-shadow", "0px " + SHADOW_SIZE + "px 0px " + shadowColor);
      element.css("border", "1px solid " + shadowColor);
    }


  };



  var lightButton = function(selector, button, changeBorder, callback){
    if(changeBorder === undefined) changeBorder = true;
    var lightColor = changeColor(button.color,[50,50,50]);
    var buttonOriginalColor = changeColor(button.color,[0,0,0]);
    var shadowColor = changeColor(button.color, [-50, -50, -50]);

    //set light
    $(selector).css("background-color", lightColor);

    if(changeBorder){
      $(selector).css("box-shadow", "0px " + SHADOW_SIZE  + "px 0px " + lightColor);
    }

    //remove light
    window.setTimeout(function(){
      $(selector).css("background-color", buttonOriginalColor);

      if(changeBorder){
        $(selector).css("box-shadow", "0px " + SHADOW_SIZE + "px 0px " + shadowColor);
      }

      if(callback !== undefined) callback();
    },BUTTON_LIGHT_TIME);
  };

  var pressButton = function(button){
    var buttonOriginalColor = changeColor(button.color,[0,0,0]);
    var buttonOriginalPosition = $(button.selector).position();
    var lightColor = changeColor(button.color,[150,150,150]);
    var shadowColor = changeColor(button.color, [-150, -150, -150]);

    //set button press effect
    $(button.selector).css("top", (buttonOriginalPosition.top + BUTTON_PRESS_SIZE) + "px");
    $(button.selector).css("box-shadow", "0px " + (SHADOW_SIZE - BUTTON_PRESS_SIZE) + "px 0px " + shadowColor);

    //set light
    $(button.selector).css("background-color", lightColor);
    $(button.selector).css("box-shadow", "0px " + SHADOW_SIZE  + "px 0px " + lightColor);

    //remove button press effect
    window.setTimeout(function(){
      $(button.selector).css("background-color", buttonOriginalColor);
      $(button.selector).css("top", buttonOriginalPosition.top + "px");
      $(button.selector).css("box-shadow", "0px " + SHADOW_SIZE + "px 0px " + shadowColor);
    },BUTTON_PRESS_TIME);
  };

  var getRandomButton = function(){
    var max = 4;
    var min = 1;
    var randomNumber = Math.floor(Math.random() * (max - min + 1)) + min;

    if(randomNumber == 1) return buttons.green;
    if(randomNumber == 2) return buttons.yellow;
    if(randomNumber == 3) return buttons.red;
    return buttons.blue;

  };

  var playRandomWinSound = function(score){
    //if(score % 2 === 0 && score > 0 ){
      
	  var max = 8;
      var min = 1;
      var randomNumber = Math.floor(Math.random() * (max - min + 1)) + min;
		
      window.playSound("/android_asset/www/sound/" + (score + 1) + ".wav");

   // }
  };

  var changeColor = function(original, change){
    function sumColor(o, c){
      var result = o + c;
      if(result > 255) return 255;
      if(result < 0) return 0;
      return result;
    }

    return "rgb(" + 
            sumColor(original[0], change[0]) + "," +
            sumColor(original[1], change[1]) + "," +
            sumColor(original[2], change[2]) + ")";
  };

  var addButtonToBreadcrumb = function(button, index){
    $("section.breadcrumb").append("<div id='breadcrumb-item-id-" + index + "'></div>");
    var breadcrumbButton = $("#breadcrumb-item-id-" + index);

    setItemColor(breadcrumbButton, button, false);

    $(breadcrumbButton).addClass("btn");
    $(breadcrumbButton).addClass("btn-default");
  };

  var wrongMove = function(loopIndex){
    if(loopIndex === undefined) loopIndex = 0;
    if(loopIndex == 4) return;

    window.setTimeout(function(){
      if(loopIndex % 2 === 0){
        $("section.buttons-container").css("margin-left", "2px");
      }else{
        $("section.buttons-container").css("margin-left", "-2px");
      }

      window.setTimeout(function(){
        $("section.buttons-container").css("margin-left", "0px");
      }, 50);

      wrongMove(loopIndex + 1);
    }, 100);
    
  };

   var blinkButton = function(button, times){
    if(times === 0) return;

    window.setTimeout(function(){
      lightButton(".button.button-" + button.name, button);
      blinkButton(button, times -1);


    }, 500);
  };

  return{
    buttons: buttons,
    renderButtons: renderButtons,
    pressButton: pressButton,
    lightButton: lightButton,
    getRandomButton: getRandomButton,
    addButtonToBreadcrumb: addButtonToBreadcrumb,
    wrongMove: wrongMove,
    blinkButton: blinkButton,
    playRandomWinSound: playRandomWinSound
  };

};



angular.module('angularApp', [])
.directive('onRepeatRender', function(){
  return {
    restrict: 'A',
    link: function(scope, element, attr){
      if(scope.$last){
          scope.$evalAsync(attr.onRepeatRender);
      }
    }
  };
})
.controller('MainController', function ($scope, $http) {
  var buttonsHandler = new ButtonsHandler();



  $scope.renderButtons = function(){
    buttonsHandler.renderButtons();
  };

  $scope.buttons = buttonsHandler.buttons;
 

  var nextMoveCancelationToken = null;
  $scope.clickGenius = function(buttonName){
    if(nextMoveCancelationToken !== null){
      clearInterval(nextMoveCancelationToken);
    }

    var button = buttonsHandler.buttons[buttonName];
    $scope.userBreadcrumb.push(button);

   

    if($scope.breadcrumb[$scope.userBreadcrumb.length -1].name === button.name){
      buttonsHandler.pressButton(buttonsHandler.buttons[buttonName]);
     // button.soundClick.load();
      window.playSound(button.soundClick);


      if($scope.userBreadcrumb.length === $scope.breadcrumb.length){
        //congrats
        //clean breadcrumb

        

        buttonsHandler.lightButton($scope.buttons.green.selector, $scope.buttons.green);
        buttonsHandler.lightButton($scope.buttons.red.selector, $scope.buttons.red);
        buttonsHandler.lightButton($scope.buttons.blue.selector, $scope.buttons.blue);
        buttonsHandler.lightButton($scope.buttons.yellow.selector, $scope.buttons.yellow);
		
        window.setTimeout(function(){
		buttonsHandler.playRandomWinSound($scope.userBreadcrumb.length -1);
		
          buttonsHandler.lightButton($scope.buttons.green.selector, $scope.buttons.green);
          buttonsHandler.lightButton($scope.buttons.red.selector, $scope.buttons.red);
          buttonsHandler.lightButton($scope.buttons.blue.selector, $scope.buttons.blue);
          buttonsHandler.lightButton($scope.buttons.yellow.selector, $scope.buttons.yellow);
			
          $scope.userBreadcrumb = [];
          $("section.breadcrumb div").removeClass("gray");
          window.setTimeout(function(){
            $scope.nextGenius();
          },1000);

        },700);
        

        
        
      }else{
        buttonsHandler.lightButton("#breadcrumb-item-id-" + ($scope.userBreadcrumb.length -1),  button, false, function(){
          $("#breadcrumb-item-id-" + ($scope.userBreadcrumb.length - 1)).addClass("gray");  
        });
        //helps if user takes too long to make next move
        nextMoveCancelationToken = window.setInterval(function(){
          if($scope.userBreadcrumb.length > 0){
            var nextColor = $scope.breadcrumb[$scope.userBreadcrumb.length];
            buttonsHandler.blinkButton(nextColor, 2);
         
            
          }
        }, 1500);
      }
    }else{
		window.playSound('/android_asset/www/sound/sound-error.wav');

      buttonsHandler.wrongMove();
      
      //clean breadcrumb
      $("section.breadcrumb div").removeClass("gray");

      console.log('you fool');
      $scope.userBreadcrumb = [];
    }

  };

  $scope.nextGenius = function(){
    var nextGeniusButton = buttonsHandler.getRandomButton();
    $scope.breadcrumb.push(nextGeniusButton);
    buttonsHandler.addButtonToBreadcrumb(nextGeniusButton, $scope.breadcrumb.length - 1);
    $scope.runGenius(0);
  };

  $scope.reset = function(){
    $("section.breadcrumb").html("");
    $scope.breadcrumb =[];
    $scope.userBreadcrumb =[];
    $scope.nextGenius();
    $scope.userBreadcrumb = [];


  };

  window.setTimeout(function(){$scope.reset();}, 500);

  $scope.runGenius = function(i){
    var INTERVAL_TIME = 400;



    window.setTimeout(function(){
      if(i <= $scope.breadcrumb.length - 1){
        $scope.runGenius(i + 1);
         var button = $scope.breadcrumb[i];
         //button.soundClick.load();
         window.playSound(button.soundClick);
         buttonsHandler.lightButton(button.selector, button);
         buttonsHandler.lightButton("#breadcrumb-item-id-" +i,  button, false);
      }
     
      
    }, INTERVAL_TIME);

  };



   function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

});

//}

   </script>
  </body>
</html>